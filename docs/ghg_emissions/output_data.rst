Output Data
===========

.. _GeoCARET: https://github.com/Reservoir-Research/geocaret
.. _RE-Emission: https://github.com/tomjanus/reemission

When GHG emission model input calculations are run in GeoCARET_, GeoCARET creates a number of outputs which are saved to several locations locally and on remote servers - see `Output Locations`_. 
This document is a guide to the output datasets generated and their location.

Run Folder
----------

Key Points
~~~~~~~~~~

* When the GeoCARET_ is run for the first time, a folder ``XHEET/tmp`` is created in the top level of your **Google Drive** assets folder. This folder is written into by the currently running ``GeoCARET`` job.

* Initially, all output files are written to the ``XHEET/tmp`` folder.

* Once the analysis is complete, all output files are copied to the permanent **Earth Engine assets folder** and to **Google Drive** [optionally].

* All files are finally deleted from ``XHEET/tmp``.

Output Locations
----------------

The results are saved into three locations:

1.  Google Earth Engine Cloud Project Assets folder
2.  Google Drive (optional)
3.  Local results folder on the user's personal machine

1. Google Earth Engine Cloud Project Assets folder
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

All output files generated by GeoCARET are saved inside your Google Earth Engine Cloud Project Assets folder. They are saved in a folder called ``XHEET``, which will be created inside the top-level folder of your cloud project.

   
.. attention::
   If your cloud project contains *multiple* top-level folders,
   GeoCARET will use the *first folder it finds*, taking the folder
   names in alphabetical order.

Each time you run the analysis, a new sub-folder will be created to hold the outputs, with the name generated constructed from the ``jobname`` argument and the timestamp of the analysis: ``XHEET/<<JOBNAME>>-<<TIMESTAMP>>``

For exmaple, if your cloud project is called ``my-ee-project`` and it has a top-level folder called ``home``, and you started the analysis at 3pm on 2024-01-01 using the following command-line command:

.. code-block:: bash

   > python heet_cli.py data/dams.csv my-ee-project job01 standard

the outputs would be stored in ``my-ee-peoject/home/XHEET/JOB01-20240101-1300``.

All outputs are native Earth Engine data structures: *feature collections*, *images* and *image collections*.

2. Google Drive (Optional)
~~~~~~~~~~~~~~~~~~~~~~~~~~

All output files can also be saved to a Google Drive folder under condition that the config option ``export_to_drive = True`` in ``delineator/heet_config.py`` - see :doc:`../config` for more information about configuration settings.
For more information, please read: :doc:`output_data_exports`.

Exported data
*************

-  Catchment, Reservoir and River delineations (vectors, feature collections) are exported as shape files.
-  Catchment areas and inundated areas (pixels, rasters, images) are exported GeoTiff images.
-  Catchment, reservoir and other parameters (feature collections) are exported as csv files.

For more information, please refer to :ref:`exports_settings`.

3. Local Results Folder
~~~~~~~~~~~~~~~~~~~~~~~

.. important::
   This destination is only for the calculated parameters, i.e. other outputs such as delineation shape files, are not saved to the local results folder. Instead they can be exported to Google Drive - see `2. Google Drive (Optional)`_.

When the analysis is complete, the calculated reservoir and catchment properties, i.e. the ``output_parameters`` are downloaded to a local results folder in the form of a CSV file called ``output_parameters.csv``. The file will be stored in the folder 

.. code-block:: bash

   outputs/<<JOBNAME>>-<<TIMESTAMP>>
   
e.g. 

.. code-block::
   
   outputs/JOB01-20220130-1450/output_parameters.csv

The values in ``output_parameters.csv`` are additionally validated against a set of constraints, e.g. minimum and maximum allowed value, defined in configuration file ``outputs.resource.yaml``. 
The validation functions are defined in ``heet_validate.py``. 
Any impossible or improbable calculated parameters are flagged in a CSV file ``heet_output_report.csv``, also saved to the local results folder.
A subset of data in ``output_parameters.csv`` is additionally saved as a specially formatted json file ``output_parameters.json`` that is designed to comply with the input file specifications of RE-Emission_. Alike the **csv** files, the **json** file will be stored in the folder 

.. code-block:: bash

   outputs/<<JOBNAME>>-<<TIMESTAMP>>
   
e.g. 

.. code-block:: bash

   outputs/JOB01-20220130-1450/output_parameters.json

Guide to Output Files
---------------------

The produced outputs come in two forms: geospatial data and tabular data.
The geospatial data is saved either in ``.shp`` or ``.GeoTiff`` format, depending whether it is in the form of vector(s) or raster(s), respectively.
The tabular data representing the *user inputs* and the *output parameters* is saved in the ``.csv`` format.

Output File Inventory
~~~~~~~~~~~~~~~~~~~~~

The output data comes in different native Earth Engine formats (see ``ee_type``) which later determines the type of the output file (see ``drive_type``).
The file names (``file_prefix``), their titles and descriptions and types are provided in the table below.

+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``file_prefix``       | title         | description                      | ``ee_type``   | ``drive_type`` |
+=======================+===============+==================================+===============+================+
| ``user_inputs``       | User          | User inputs                      | Feature       | CSV            |
|                       | inputs        |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``P_*``               | Raw dam       | The raw dam location input by    | Feature       | SHP            |
|                       | location      | the user                         | Collection    |                |
|                       |               |                                  | [Ftc-ft-pt]   |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``PS_*``              | Snapped       | Dam location snapped to nearest  | Feature       | SHP            |
|                       | dam           | hydroriver                       | Collection    |                |
|                       | location      |                                  | [Ftc-ft-pt]   |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WCPTS_``            | Watershed     | Watershed search grid.           | Feature       | SHP            |
|                       | candidate     | Hydrobasins 12 subbasin of dam   | Collection    |                |
|                       | points        | converted to a grid of point     | [Ftc-fts-pts] |                |
|                       |               | locations (15’ pixel centres).   |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WDPTS_``            | Watershed     | Points on watershed search grid  | Feature       | SHP            |
|                       | detected      | found by algorithm to belong to  | Collection    |                |
|                       | points        | dam catchment.                   | [Ftc-fts-pts] |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``CX_``               | Catchment     | Catchment pixels                 | Image         | GeoTiff        |
|                       | pixels        |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``C_``                | Catchment     | Catchment boundary               | Feature       | SHP            |
| ``c_``                | boundary      |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WBSX_``             | Waterbodies   | Waterbodies pixels               | Image         | GeoTiff        |
|                       | pixels        |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WBS_``              | Waterbodies   | Waterbodies boundaries           | Feature       | SHP            |
|                       | boundaries    |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``R_``                | Reservoir     | Reservoir boundary; boundary of  | Feature       | SHP            |
| ``r_``                | boundary      | waterbody which intersects the   | Collection    |                |
|                       |               | snapped dam location (or raw     |               |                |
|                       |               | location for existing dams).     |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``rbz_``              | Reservoir     | Buffer zone around reservoir     | Feature       | SHP            |
|                       | buffer        | (used for landcover analysis of  | Collection    |                |
|                       | zone          | existing dams commissioned       |               |                |
|                       |               | <=1992)                          |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``sr_``               | Simplified    | Simplified reservoir boundary    | Feature       | SHP            |
|                       | implified     | (the outer boundary of the       | Collection    |                |
|                       | reservoir     | reservoir ignoring any islands). |               |                |
|                       | boundary      | Used to determine inundated      |               |                |
|                       |               | river.                           |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``S_``                | Inundated     | Inundated river reaches (stream  | Feature       | SHP            |
| ``s_``                | river         | line)                            | Collection    |                |
|                       | reaches       |                                  |               |                |
|                       | (streamline)  |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``MS_``               | Main          | Main inundated river channel.    | Feature       | SHP            |
| ``ms_``               | inundated     |                                  | Collection    |                |
|                       | river channel |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``N_``                | Non-inundeted | Non inundated catchment          | Feature       | SHP            |
| ``n_``                | catchment     |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``output_parameters`` | Calculated    | Calculated parematers            | Tabular       | CSV            |
|                       | Parameters    |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+

.. _output_data_specs:

Output Data Specification
~~~~~~~~~~~~~~~~~~~~~~~~~

The variables output by GeoCARET in the tabular format are listed and described in the table below.


.. csv-table:: Specification of output variables saved in the tabular output form.
   :file: ../_static/files/99_output_specification1.csv
   
The specification can be also downloaded in a CSV file format by clicking on the icon below.

.. image:: ../_static/images/spreadsheet-2127832_640.png
   :width: 100
   :alt: Spreadsheet file icon
   :target: ../_static/files/99_output_specification1.csv
   
Guide to Codes
--------------

Error Codes
~~~~~~~~~~~

If the analysis of a dam location fails part way through, all output files and parameters calculated up to the point of failure will be saved and exported. 
Any parameters that cannot be calculated are assigned a missing value using the codes below. 
An error code is assigned to each dam to indicate whether the analysis completed successfully or not.

+-----------------------+-----------------------------------------------+
| Code                  | Definition                                    |
+=======================+===============================================+
| 0                     | No Error (complete analysis)                  |
+-----------------------+-----------------------------------------------+
| 1                     | Analysis failed at snapping dam to hydroriver |
+-----------------------+-----------------------------------------------+
| 2                     | Analysis failed at catchment delineation or   |
|                       | catchment parameter generation                |
+-----------------------+-----------------------------------------------+
| 3                     | Analysis failed at reservoir delineation or   |
|                       | reservoir parameter generation                |
+-----------------------+-----------------------------------------------+
| 4                     | Analysis failed at non-inundated catchment    |
|                       | delineation or non-inundated catchment        |
|                       | parameter generation                          |
+-----------------------+-----------------------------------------------+
| 5                     | Analysis failed at river delineation or river |
|                       | parameter generation                          |
+-----------------------+-----------------------------------------------+

Missing Data Codes
~~~~~~~~~~~~~~~~~~

Missing data, e.g. data that could not be calculated for some reason or the calculation method is still under development, is handled in several ways depending on the root cause of the data being missing. See below

1.  Missing numerical/string parameters, which are still "under development" are assigned a string value of “UD”.
2.  Missing numerical parameters (which are not under developemnt) are assigned a string value of “NA” (happens when delineation has failed).
3.  Missing parameters are assigned a string value of “NONE” (happens when delineation has failed).
4.  Missing numerical parameters are assigned a string value of “ND” when calculation evaluates to None, e.g. if there is missing data in GIS layer.
5.  Missing string parameters are assigned a string value of “NODATA” when calculation evaluates to None e.g. if there is missing data in GIS layer.

Provenance Codes
~~~~~~~~~~~~~~~~

.. note::
   Applies to future dams only.

The variable ``r_imputed_water_elevation_prov`` is a key variable that is used to indicate how water elevation of the future dam has been derived for delineation.

+-----------------------+-----------------------------------------------+
| Code                  | Definition                                    |
+=======================+===============================================+
| 0                     | User input full supply level                  |
+-----------------------+-----------------------------------------------+
| 1                     | User input dam height                         |
+-----------------------+-----------------------------------------------+
| 2                     | Dam height estimated from power capacity      |
|                       | (user inputted turbine efficiency)            |
+-----------------------+-----------------------------------------------+
| 3                     | Dam height estimated from power capacity      |
|                       | (assuming turbine efficiency of 85%)          |
+-----------------------+-----------------------------------------------+

.. attention::
   Plant depth is assumed to be “0” unless the user-specified a different value.

Handling existing dams
----------------------

When modelling existing dams, the following parameters cannot be generated due to the lack of elevation data that pre-dates commissioning:

-  ``r_imputed_water_elevation``
-  ``r_volume_m3``
-  ``r_mean_depth_m``
-  ``r_maximum_depth_m``
-  ``r_maximum_depth_m_alt1``
-  ``r_maximum_depth_m_alt2``

.. attention::
   This data needs to be provided manually, e.g. obtained from different data sources.
   
.. hint::
   For the purpose of GHG emission estimation we need: **reservoir volume**, **mean dept h** and **max depth**. Additional knowledge of bathymetry is very helpful for estimating CH4 emissions as it allows a more accurate estimation of the littoral zone, but it is not mandatory. Rather a luxury to have.
