Background
==========

.. _GeoCARET: https://github.com/Reservoir-Research/geocaret

.. attention::
    In order to use the GeoCARET tool, you must be registered to use Google Earth Engine, and have a Google Cloud Project setup. See`GeoCARET Prerequisites <01_prerequisites.md>`__ for full details.

When GeoCARET_ is run, a number of outputs are generated and are saved to several locations. This document is a guide to the output datasets generated and their location.

Run Folder
----------

When the GeoCARET_ is run for the first time, a folder ``XHEET/tmp`` is created in the top level of your Google Drive assets folder.

This folder is always used by the currently running ``HEET`` job.

Initially, all output files are written to the ``XHEET/tmp`` folder.

Once the analysis is complete, all output files are copied to a permanent earth engine assets folder and optionally to Google Drive.

All files are then deleted from ``XHEET/tmp`` ready for the next analysis.

Output Locations
----------------

   Results from GeoCARET_ are saved in three locations:

   -  Google Earth Engine Cloud Project Assets folder
   -  Google Drive (optional)
   -  Local results folder

Google Earth Engine Cloud Project Assets folder
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

All output files generated by GeoCARET are saved inside your Google Earth Engine Cloud Project Assets folder. They are saved in a folder called ``XHEET``, which will be created inside the top-level folder of your cloud project.

   **NOTE** if your cloud project contains *multiple* top-level folders,
   GeoCARET will use the *first folder it finds*, taking the folder
   names in alphabetical order.

Each time you run a GeoCARET_ analysis, a new sub-folder will be created to hold the outputs, with the name generated using the ‘jobname’ argument passed to the tool, and the timestamp of the analysis:

``XHEET/<<JOBNAME>>-<<TIMESTAMP>>``

For exmaple, if your cloud project is called *my-ee-project* and it has a top-level folder called *home*, and you started an analysis using the following arguments, at 3pm on 2024-01-01:

::

   > python heet_cli.py data/dams.csv my-ee-project myanmar01 standard

Then the outputs would be stored in the following location:

``my-ee-peoject/home/XHEET/MYANMAR01-20240101-1300``

All outputs are native earth engine data structures: feature collections, images or image collections.

Google Drive (Optional)
~~~~~~~~~~~~~~~~~~~~~~~

!! **FIXME**: this will probably require updating !!

All output files generated are saved to a Google Drive folder if config option ``export_to_drive`` is set to True in delineator/heet_config:

``XHEET-<<JOBNAME>>-<<TIMESTAMP>> e.g. XHEET-MYANMAR01-20220130-1450``

-  Catchment, Reservoir and River delineations (vectors, feature collections) are exported as shape files.
-  Catchment areas and inundated areas (pixels, rasters, images) are exported GeoTiff images.
-  Catchment, reservoir and other parameters (feature collections) are exported as csv files.

Note the following earth engine documentation:

“The Google Drive Folder that the export will reside in. Note: (a) if the folder name exists at any level, the output is written to it, (b) if duplicate folder names exist, output is written to the most recently modified folder, (c) if the folder name does not exist, a new folder will be created at the root, and (d) folder names with separators (e.g. ‘path/to/file’) are interpreted as literal strings, not system paths. Defaults to Drive root.”

https://developers.google.com/earth-engine/apidocs/export-table-todrive

Local Results Folder **(calculated parameters only)**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When the analysis is complete, calculated properties (output_parameters) are downloaded to a local results folder as a CSV file
(``output_parameters.csv``).

``outputs/<<JOBNAME>>-<<TIMESTAMP>> e.g. outputs/MYANMAR01-20220130-1450/output_parameters.csv``

The contents of output_parameters.csv is validated against a set of constraints in ``outputs.resource.yaml`` and ``heet_validate.py``. Any impossible or improbable calculated parameters are flagged in file ``heet_output_report.csv``

A subset of the outputs in ``output_parameters.csv`` are output as a json file ``output_parameters.json``.

``outputs/<<JOBNAME>>-<<TIMESTAMP>> e.g. outputs/MYANMAR01-20220130-1450/output_parameters.json``

Run Folder
----------

When the GeoCARET_ tool is run for the first time, a folder called ``tmp`` is created in the ``XHEET`` sub-folder of your cloud project.

This folder is always used by the currently running ``GeoCARET`` job.
Initially, all output files are written to the ``XHEET/tmp`` folder.

Once the analysis is complete, all output files are copied to a job-specific sub-folder, as described in the section ``Google Earth Engine Cloud Project Assets folder`` above. All files are then deleted from ``XHEET/tmp`` ready for the next analysis.

Exporting to Google Drive Later
===============================

!! **FIXME**: I’ve not been able to test this so it may need updating !!

If config option ``export_to_drive`` is set to False in delineator/heet_config, results will not be exported to Google Drive
automatically. To export GeoCARET_ results to Google Drive at a later time, use utility script heet_export_cli.py which is run as follows:

::

   > python heet_export_cli.py users/kkh451/XHEET/MYDAMSD22_20230107-2140 XHEET_MYDAMSD22_20230107-2140 

Two arguments must be supplied:

::

   > python heet_export_cli.py [1] users/kkh451/XHEET/MYDAMSD22_20230107-2140 [2]XHEET_MYDAMSD22_20230107-2140 

-  [1] The path to the results folder on your earth engine account
-  [2] Destination folder on Google drive (note only a single top-level
   folder can be specified)

Note the following earth engine documentation:

“The Google Drive Folder that the export will reside in. Note: (a) if the folder name exists at any level, the output is written to it, (b) if duplicate folder names exist, output is written to the most recently modified folder, (c) if the folder name does not exist, a new folder will be created at the root, and (d) folder names with separators (e.g. ‘path/to/file’) are interpreted as literal strings, not system paths. Defaults to Drive root.”

Guide to Output Files
=====================

Output File Inventory
---------------------

+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``file_prefix``       | title         | description                      | ``ee_type``   | ``drive_type`` |
+=======================+===============+==================================+===============+================+
| ``user_inputs``       | User          | User inputs                      | Feature       | CSV            |
|                       | inputs        |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``P_*``               | Raw dam       | The raw dam location input by    | Feature       | SHP            |
|                       | location      | the user                         | Collection    |                |
|                       |               |                                  | [Ftc-ft-pt]   |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``PS_*``              | Snapped       | Dam location snapped to nearest  | Feature       | SHP            |
|                       | dam           | hydroriver                       | Collection    |                |
|                       | location      |                                  | [Ftc-ft-pt]   |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WCPTS_``            | Watershed     | Watershed search grid.           | Feature       | SHP            |
|                       | candidate     | Hydrobasins 12 subbasin of dam   | Collection    |                |
|                       | points        | converted to a grid of point     | [Ftc-fts-pts] |                |
|                       |               | locations (15’ pixel centres).   |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WDPTS_``            | Watershed     | Points on watershed search grid  | Feature       | SHP            |
|                       | detected      | found by algorithm to belong to  | Collection    |                |
|                       | points        | dam catchment.                   | [Ftc-fts-pts] |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``CX_``               | Catchment     | Catchment pixels                 | Image         | GeoTiff        |
|                       | pixels        |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``C_``                | Catchment     | Catchment boundary               | Feature       | SHP            |
| ``c_``                | boundary      |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WBSX_``             | Waterbodies   | Waterbodies pixels               | Image         | GeoTiff        |
|                       | pixels        |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``WBS_``              | Waterbodies   | Waterbodies boundaries           | Feature       | SHP            |
|                       | boundaries    |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``R_``                | Reservoir     | Reservoir boundary; boundary of  | Feature       | SHP            |
| ``r_``                | boundary      | waterbody which intersects the   | Collection    |                |
|                       |               | snapped dam location (or raw     |               |                |
|                       |               | location for existing dams).     |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``rbz_``              | Reservoir     | Buffer zone around reservoir     | Feature       | SHP            |
|                       | buffer        | (used for landcover analysis of  | Collection    |                |
|                       | zone          | existing dams commissioned       |               |                |
|                       |               | <=1992)                          |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``sr_``               | Simplified    | Simplified reservoir boundary    | Feature       | SHP            |
|                       | implified     | (the outer boundary of the       | Collection    |                |
|                       | reservoir     | reservoir ignoring any islands). |               |                |
|                       | boundary      | Used to determine inundated      |               |                |
|                       |               | river.                           |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``S_``                | Inundated     | Inundated river reaches (stream  | Feature       | SHP            |
| ``s_``                | river         | line)                            | Collection    |                |
|                       | reaches       |                                  |               |                |
|                       | (streamline)  |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``MS_``               | Main          | Main inundated river channel.    | Feature       | SHP            |
| ``ms_``               | inundated     |                                  | Collection    |                |
|                       | river channel |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``N_``                | Non-inundeted | Non inundated catchment          | Feature       | SHP            |
| ``n_``                | catchment     |                                  | Collection    |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+
| ``output_parameters`` | Calculated    | Calculated parematers            | Tabular       | CSV            |
|                       | Parameters    |                                  |               |                |
+-----------------------+---------------+----------------------------------+---------------+----------------+

Export Settings and Outputs
---------------------------

+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``file_prefix``       | title        | st  | ex  | di   | diag   | diag  | diag  |
|                       |              | and | ten | agno | nostic | nosti | nosti |
|                       |              | ard | ded | stic | -catch | c-res | c-riv |
+=======================+==============+=====+=====+======+========+=======+=======+
| ``user_inputs``       | User inputs  | X   | X   | X    | X      | X     | X     |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``P_*``               | Raw dam      |     | X   | X    | X      | X     |       |
|                       | location     |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``PS_*``              | Snapped dam  | X   | X   | X    | X      | X     | X     |
|                       | location     |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``WCPTS_``            | Watershed    |     |     | X    | X      |       |       |
|                       | candidate    |     |     |      |        |       |       |
|                       | points       |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``WDPTS_``            | Watershed    |     |     | X    | X      |       |       |
|                       | detected     |     |     |      |        |       |       |
|                       | points       |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``CX_``               | Catchment    |     |     | X    | X      |       |       |
|                       | pixels       |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``C_``                | Catchment    | X   | X   | X    | X      | X     | X     |
| ``c_``                | boundary     |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``WBSX_``             | Waterbodies  |     |     | X    |        | X     |       |
|                       | pixels       |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``WBS_``              | Waterbodies  |     |     | X    |        | X     |       |
|                       | boundaries   |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``R_``                | Reservoir    | X   | X   | X    | X      | X     | X     |
| ``r_``                | boundary     |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``rbz_``              | Reservoir    | X   | X   | X    | X      | X     | X     |
|                       | buffer zone  |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``sr_``               | Simplified   |     |     |      |        |       | X     |
|                       | reservoir    |     |     |      |        |       |       |
|                       | boundary     |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``S_``                | Inundated    |     |     |      |        |       | X     |
| ``s_``                | river        |     |     |      |        |       |       |
|                       | reaches      |     |     |      |        |       |       |
|                       | (streamline) |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``MS_``               | Main         | X   | X   | X    | X      | X     | X     |
| ``ms_``               | indundated   |     |     |      |        |       |       |
|                       | river        |     |     |      |        |       |       |
|                       | channel      |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``N_``                | Noninundated | X   | X   | X    | X      | X     | X     |
| ``n_``                | catchment    |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+
| ``output_parameters`` | Calculated   | X   | X   | X    | X      | X     | X     |
|                       | Parameters   |     |     |      |        |       |       |
+-----------------------+--------------+-----+-----+------+--------+-------+-------+

Error Codes
-----------

If the analysis of a dam location fails part way through, all output files and parameters calculated up to the point of failure will be saved and exported. Any parameters that cannot be calculated are assigned a missing value using the codes below. An error code is assigned to each dam to indicate whether the analysis completed successfully.

+-----------------------+-----------------------------------------------+
| Code                  | Definition                                    |
+=======================+===============================================+
| 0                     | No Error (complete analysis)                  |
+-----------------------+-----------------------------------------------+
| 1                     | Analysis failed at snapping dam to hydroriver |
+-----------------------+-----------------------------------------------+
| 2                     | Analysis failed at catchment delineation or   |
|                       | catchment parameter generation                |
+-----------------------+-----------------------------------------------+
| 3                     | Analysis failed at reservoir delineation or   |
|                       | reservoir parameter generation                |
+-----------------------+-----------------------------------------------+
| 4                     | Analysis failed at non-inundated catchment    |
|                       | delineation or non-inundated catchment        |
|                       | parameter generation                          |
+-----------------------+-----------------------------------------------+
| 5                     | Analysis failed at river delineation or river |
|                       | parameter generation                          |
+-----------------------+-----------------------------------------------+

Missing Data Codes
------------------

-  Missing numeric/string parameters are assigned a string value of “UD” when parameters are “under development”
-  Numeric missing parameters are assigned a string value of “NA” (when delineation has failed)
-  String missing parameters are assigned a string value of “NONE” (when delineation has failed)
-  Numeric missing parameters are assigned a string value of “ND” (when calculation evaluates to None e.g. if there is missing data in GIS layer)
-  String missing parameters are assigned a string value of “NODATA” (when calculation evaluates to None e.g. if there is missing data in GIS layer)

Provenance Codes
----------------

The variable ``r_imputed_water_elevation_prov`` is a key variable that is used to indicate how the future water elevation of the dam has been derived for the purposes of delineating the reservoir.

+-----------------------+-----------------------------------------------+
| Code                  | Definition                                    |
+=======================+===============================================+
| 0                     | User inputted full supply level               |
+-----------------------+-----------------------------------------------+
| 1                     | User input dam height                         |
+-----------------------+-----------------------------------------------+
| 2                     | Dam height estimated from power capacity      |
|                       | (user inputted turbine efficiency)            |
+-----------------------+-----------------------------------------------+
| 3                     | Dam height estimated from power capacity      |
|                       | (assuming turbine efficiency of 85%)          |
+-----------------------+-----------------------------------------------+

Plant depth is assumed to be “0” unless a user-specified value is provided.

Existing dams
-------------

When modelling existing dams, the following parameters cannot be generated due to a lack of elevation data that pre-dates commissioning:

-  ``r_imputed_water_elevation``
-  ``r_volume_m3``
-  ``r_mean_depth_m``
-  ``r_maximum_depth_m``
-  ``r_maximum_depth_m_alt1``
-  ``r_maximum_depth_m_alt2``
